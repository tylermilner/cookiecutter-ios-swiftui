name: Test

on: [push, workflow_dispatch]

concurrency:
  # Cancel any in-progress runs for this workflow/branch combination
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Set up Python, including cache for pipenv virtual environment
        uses: actions/setup-python@v5
        with:
          python-version-file: .python-version
          cache: pipenv

      - name: Install pipenv
        run: |
          pip install --upgrade pip
          pip install pipenv

      - name: Install project dependencies
        run: pipenv install --dev

      - name: Run tests
        run: pipenv run pytest

      - name: Generate template from defaults
        run: ./generate-default-project.sh

      - name: Upload generated template
        uses: actions/upload-artifact@v4
        id: upload-generated-template
        with:
          name: template-output
          path: my-app

  changes:
    runs-on: ubuntu-22.04
    needs: test
    outputs:
      template_files: ${{ steps.filter.outputs.template_files }}
    steps:
      - uses: actions/checkout@v4
      - name: Check for changes in the iOS template files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            template_files:
              - '{{ cookiecutter.project_root }}/**'
  
  deploy:
    runs-on: ubuntu-22.04
    needs: [test, changes]
    if: ${{ needs.changes.outputs.template_files == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'tylermilner/cookiecutter-ios-swiftui-output'
          ref: 'main'
          token:  ${{ secrets.TEMPLATE_OUTPUT_REPO_TOKEN }}

      - name: Setup git config
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "<>"

      - name: Download generated template
        uses: actions/download-artifact@v4
        with:
          name: template-output

      - name: Commit and push generated template
        run: |
          export COMMIT_MESSAGE="Generated template from ${{ github.repository }}/${{ github.ref}}@${{ github.sha }}"
          git add .
          git commit -m "$COMMIT_MESSAGE"
          git push
